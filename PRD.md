> Михаил:
# Product Requirements Document: Приложение для хранения и обмена информацией о рейсах

* Версия: 1.0 (Обновлено после уточнений)
* Дата: 25 апреля 2025 г.
* Статус: Готово к разработке основных функций.

## 1. Введение

### 1.1. Цель

Создать исключительно веб-приложение, позволяющее зарегистрированным пользователям хранить, просматривать и управлять информацией о своих авиаперелетах, а также просматривать полеты других пользователей, находить пользователей по имени и сравнивать их статистику перелетов через любой современный браузер. Приложение будет реализовано с использованием современного веб-стека на базе Next.js и Backend-as-a-Service (BaaS) платформы Firebase, размещено на Vercel.

### 1.2. Целевая аудитория

* Частные лица, часто летающие самолетами (путешественники, командировочные), которые хотят вести учет своих перелетов в одном месте с использованием веб-интерфейса, а также делиться информацией о своих перелетах и сравнивать свою активность с другими путешественниками.

### 1.3. Ключевые проблемы и решения

* Проблема: Ручной учет перелетов в заметках, таблицах или разрозненных источниках неудобен. Отсутствие удобной платформы для обмена информацией о перелетах и сравнения активности с другими путешественниками.
* Решение: Предоставить централизованное веб-приложение для простого добавления, импорта, просмотра и управления данными о рейсах, а также с функциями публичного просмотра рейсов других пользователей, поиска пользователей и сравнения их полетной статистики.

## 2. Пользовательские сценарии (User Stories)

* Как пользователь, я хочу зарегистрироваться и войти в систему через веб-форму, чтобы получить доступ к своим данным и функциям приложения.
* Как пользователь, я хочу иметь возможность вручную добавлять информацию о новом рейсе через веб-форму.
* Как пользователь, я хочу иметь возможность импортировать данные о рейсах из табличного файла CSV определенного формата через функцию загрузки файла в веб-приложении, чтобы быстро добавить много рейсов.
* Как пользователь, я хочу видеть список доступных мне рейсов на одной странице в веб-интерфейсе (по умолчанию - всех публичных рейсов, с возможностью постраничного просмотра).
* Как пользователь, я хочу иметь возможность фильтровать список видимых мне рейсов по дате вылета, авиакомпании, городу вылета/прилета с помощью элементов управления в веб-интерфейсе, чтобы быстро находить нужные рейсы.
* Как пользователь, я хочу иметь возможность редактировать информацию о ранее добавленном *мной* рейсе, открыв его в веб-форме, чтобы исправить ошибки или добавить детали.
* Как пользователь, я хочу иметь возможность удалять информацию о рейсе, который *я* добавил, через интерфейс приложения.
* Новое: Как пользователь, я хочу найти других зарегистрированных пользователей по имени через веб-интерфейс.
* Новое: Как пользователь, я хочу просмотреть список полетов другого пользователя, найдя его через поиск.
* Новое: Как пользователь, я хочу видеть статистику перелетов для каждого пользователя (например, общее количество рейсов, суммарное время в воздухе).
* Новое: Как пользователь, я хочу сравнить статистику своих перелетов с полетами других пользователей (найденных через поиск), чтобы увидеть, кто больше летает.

## 3. Требования к функциональности

### 3.1. Управление пользователями

* Регистрация: Пользователи должны иметь возможность зарегистрироваться, указав Email, пароль и Имя в веб-форме. Имя будет использоваться для поиска и сравнения. Пароль должен храниться в безопасном виде.
* Аутентификация: Зарегистрированные пользователи должны иметь возможность войти в систему, используя свой Email и пароль через веб-интерфейс.
* Реализация: Будет использоваться сервис аутентификации Firebase Auth. Данные профиля пользователя (включая Имя) будут храниться в Firebase Firestore в отдельной коллекции users.

### 3.2. Управление данными о рейсах

> Михаил:
* 3.2.1. Хранимые данные (для каждого рейса):
    * flight_number (Номер рейса): Строка, обязательное.
    * airline (Авиакомпания): Строка, обязательное.
    * departure_city (Город вылета): Строка, обязательное.
    * arrival_city (Город прилета): Строка, обязательное.
    * departure_time_local (Дата и время вылета, локальное): Дата и время, обязательное.
    * departure_timezone (Часовой пояс аэропорта вылета): Строка (идентификатор IANA, например, "Europe/Moscow"), обязательное.
    * arrival_time_local (Дата и время прилета, локальное): Дата и время, обязательное.
    * arrival_timezone (Часовой пояс аэропорта прилета): Строка (идентификатор IANA), обязательное.
    * seat_number (Место в самолете): Строка, необязательное.
    * aircraft_type (Тип самолета): Строка, необязательное.
    * user_id (Идентификатор пользователя): Ссылка на пользователя, которому принадлежит запись. Это поле используется для связывания рейса с его владельцем (для прав на изменение/удаление) и для группировки рейсов при просмотре профиля или сравнении.
    * *Примечание:* Точные типы данных (особенно для дат и времени - Firestore Timestamps) будут соответствовать требованиям Firebase Firestore.

* 3.2.2. Операции с рейсами:
    * Добавление рейса: Пользователь должен иметь возможность добавить информацию о новом рейсе через веб-форму, включающую все поля из п. 3.2.1 (кроме user_id, который присваивается автоматически текущему пользователю). Должна выполняться валидация вводимых данных (форматы, обязательные поля) на стороне клиента и/или сервера.
    * Импорт рейсов из CSV:
        * Пользователь должен иметь возможность загрузить файл CSV через специальный элемент управления в веб-интерфейсе для массового добавления рейсов.
        * Формат CSV: Заголовок обязателен. Разделитель - запятая, текст в двойных кавычках. Кодировка UTF-8.
           
            "Номер рейса","Авиакомпания","Город вылета","Город прилета","Дата и время вылета (ГГГГ-ММ-ДД ЧЧ:ММ)","Дата и время прилета (ГГГГ-ММ-ДД ЧЧ:ММ)","Тип самолета","Место"
            
        * Обработка: Импорт должен выполняться на стороне сервера (Next.js API route).
        * Определение часовых поясов: При импорте необходимо автоматически определять departure_timezone и arrival_timezone на основе departure_city и arrival_city с использованием серверной библиотеки с базой данных IANA.
        * Обработка ошибок: Система должна сообщать пользователю об успешном импорте или предоставлять подробный отчет об ошибках (с указанием строк и причин) в веб-интерфейсе.
    * Просмотр списка рейсов: Отображать список доступных рейсов (по умолчанию - всех публичных, или рейсов конкретного пользователя после поиска) в веб-интерфейсе. Список должен быть отсортирован по дате вылета (от новых к старым) по умолчанию. При большом количестве рейсов (>20 на страницу) должна использоваться пагинация в веб-интерфейсе.
    * Фильтрация рейсов: Пользователь должен иметь возможность фильтровать список видимых ему рейсов по:
        * Диапазону дат вылета (от/до).
        * Авиакомпании (выбор из списка использованных или ввод текста).
        * Городу вылета (выбор из списка использованных или ввод текста).
        * Городу прилета (выбор из списка использованных или ввод текста).
        * Фильтры применяются через элементы управления в веб-интерфейсе и работают на стороне сервера.
        * Фильтры должны применяться комбинированно.
    * Редактирование рейса: Пользователь должен иметь возможность изменить любую информацию о ранее добавленном им рейсе через веб-форму, аналогичную форме добавления. Редактировать можно только свои рейсы.
    * Удаление рейса: Пользователь должен иметь возможность удалить запись о рейсе, добавленном им, через кнопку или ссылку в веб-интерфейсе. Требуется подтверждение перед удалением. Удалять можно только свои рейсы.

> Михаил:
* 3.2.3. Поиск пользователей:
    * Пользователь должен иметь возможность найти других зарегистрированных пользователей по Имени, введенному при регистрации, через специальный элемент поиска в веб-интерфейсе.
    * Результаты поиска должны отображать список пользователей, соответствующих запросу.

* 3.2.4. Статистика перелетов пользователей:
    * Для каждого пользователя должна рассчитываться и отображаться агрегированная статистика:
        * Общее количество совершенных рейсов.
        * Суммарное время, проведенное в воздухе (на основе разницы arrival_time_local и departure_time_local с учетом часовых поясов).
    * Эти агрегированные данные (количество рейсов, время в воздухе) должны храниться в профиле пользователя (в коллекции users) и автоматически обновляться при добавлении, изменении или удалении рейсов пользователя (реализуется с использованием Firebase Cloud Functions).

* 3.2.5. Сравнение пользователей:
    * Пользователь должен иметь возможность выбрать двух или более пользователей из результатов поиска или другого списка.
    * Должен отображаться интерфейс сравнения, наглядно представляющий их агрегированную статистику (количество рейсов, время в воздухе).

## 4. Нефункциональные требования

### 4.1. Производительность

* Время загрузки основной страницы со списком рейсов в браузере пользователя не должно превышать 3 секунд при типичном интернет-соединении.
* Операции фильтрации и пагинации в веб-интерфейсе должны выполняться менее чем за 1 секунду.
* Импорт CSV-файла (до 1000 строк) должен занимать разумное время (уточнить метрику, например, < 30 секунд) с отображением статуса и подробного отчета об ошибках в веб-интерфейсе.
* Поиск пользователей и отображение статистики/сравнения должны выполняться быстро (менее 1-2 секунд). Агрегированные данные в профилях пользователей критичны для этой метрики.
* Бэкенд (Firebase) и фронтенд (Vercel) должны обеспечивать достаточную производительность для ожидаемого числа пользователей (уточнить ожидаемое число, если возможно, например, до 100 одновременно активных пользователей на начальном этапе).

### 4.2. Безопасность

* Все соединения с сервером должны происходить по HTTPS (обеспечивается Vercel/Firebase).
* Пароли пользователей должны храниться в хэшированном виде с использованием соли (обеспечивается Firebase Auth).
* Изменение: Данные о рейсах пользователей (за исключением полей, явно отмеченных как приватные в будущих версиях, что пока не предусмотрено) доступны для чтения любым аутентифицированным пользователем. Изменение и удаление рейсов доступно только их владельцам.
* Данные профилей пользователей (кроме email/пароля) доступны для чтения другим пользователям (для поиска и сравнения). Изменение данных профиля доступно только его владельцу.
* Необходимо реализовать базовую защиту от веб-уязвимостей (например, XSS, CSRF) через возможности Next.js и Firebase Security Rules.
* Данные в CSV-файлах должны валидироваться при импорте для предотвращения инъекций или некорректных данных.

### 4.3. Масштабируемость

* Архитектура на базе Vercel и Firebase предполагает хорошую горизонтальную масштабируемость "из коробки" для обслуживания веб-запросов.
* Использование Firebase Cloud Functions для обновления агрегированных данных способствует масштабируемости логики бэкенда.
* Структура данных в Firestore и стратегия индексации (особенно для поиска и агрегирования) критичны для масштабируемости при росте числа пользователей и рейсов.

### 4.4. Надежность и Доступность

* Ожидается доступность сервиса для веб-пользователей на уровне 99.5% (зависит от SLA Vercel и Firebase).
* Должны быть предусмотрены механизмы обработки ошибок (например, при недоступности BaaS, ошибках импорта) с информированием пользователя в веб-интерфейсе.

### 4.5. Юзабилити (Удобство использования)

> Михаил:
* Веб-интерфейс должен быть интуитивно понятным и простым в использовании, включая поиск пользователей и сравнение.
* Формы в веб-приложении должны содержать подсказки и валидацию в реальном времени.
* Процесс импорта через веб-интерфейс должен быть понятным, с четкой обратной связью и подробным отчетом об ошибках.
* Отображение статистики и сравнения должно быть наглядным.

## 5. Дизайн и UX

* Будет использоваться утилитарный подход к стилизации с помощью Tailwind CSS и готовых компонентов из библиотеки shadcn/ui.
* Дизайн веб-приложения должен быть чистым, адаптивным (корректно отображаться на десктопах и мобильных устройствах в браузере).
* Должны быть разработаны UI элементы для поиска пользователей, отображения их профилей со статистикой и интерфейса сравнения.
* Конкретные макеты или прототипы на данный момент отсутствуют [или указать, если есть].

## 6. Идеи для будущих версий (v2.0+)

* Социальная функция "Кто летел тем же рейсом" (может быть реализована с учетом публичности данных) реализованная в веб-интерфейсе.
* Генерация ссылок на Flightradar24 для рейсов в интерфейсе приложения.
* Продвинутые статистические отчеты/визуализации отображаемые в веб-приложении (карты полетов и т.п.).
* Интеграция с календарями (экспорт рейсов в формате .ics) инициируемая из веб-приложения.
* Загрузка фото/воспоминаний к рейсам через веб-форму.
* Продвинутый импорт (например, из email-подтверждений) через веб-интерфейс.
* Реализация приватных полей или приватных рейсов (опционально).

## 7. Технологический стек и Архитектура

### 7.1. Архитектура

* Клиент-серверная архитектура.
* Клиент: Веб-приложение на базе Next.js, работающее в браузере пользователя, размещенное на Vercel.
* Бэкенд: Функции бэкенда (хранение данных, аутентификация, серверная логика, автоматическое агрегирование статистики) предоставляются Firebase. Дополнительная серверная логика (импорт CSV, поиск пользователей, расчет сравнения) реализуется через Next.js API Routes и/или Firebase Cloud Functions.
* Взаимодействие: Клиент (веб-приложение в браузере) взаимодействует напрямую с Firebase через SDK (для разрешенных операций, например, чтение публичных данных, запись своих) и с серверными функциями/API Routes по HTTPS (для операций, требующих серверной логики, например, импорт, поиск).

### 7.2. Технологии

* Язык: TypeScript, JavaScript.
* Фронтенд (Веб): Next.js (TSX), React, Tailwind CSS, shadcn/ui.
* Бэкенд / База данных / Аутентификация / Серверные функции: Firebase (Authentication, Firestore, Cloud Functions).
* Хостинг (Веб-приложения): Vercel.
* Пакетный менеджер: pnpm.
* Система контроля версий: Git.
* Репозиторий: [УТОЧНИТЬ - по умолчанию GitHub].

### 7.3. Ключевые технические решения

* Обработка CSV: Сервер-сайд (Next.js API route) с использованием PapaParse.
* Работа с часовыми поясами:
    * Хранение локального времени и идентификатора часового пояса IANA.
    * Механизм определения часового пояса города при импорте: использование серверной библиотеки с базой данных IANA.
    * Использование клиентской библиотеки для корректного отображения (например, date-fns-tz, luxon) в веб-интерфейсе.
* Агрегирование статистики: Использование Firebase Cloud Functions (триггеров) для автоматического обновления totalFlights и totalAirTime в профиле пользователя при изменении его данных о рейсах.
* Поиск пользователей: Реализация логики поиска по полю name в коллекции users (через API Route или Cloud Function).
* Правила безопасности: Конфигурация Firebase Security Rules для обеспечения публичного чтения рейсов и профилей, но приватного изменения/удаления.

## 8. Критерии приемки (Примеры)

* Пользователь может успешно зарегистрироваться (с указанием Имени) и войти в систему через веб-интерфейс.

> Михаил:
* Пользователь может добавить, отредактировать и удалить *свой* рейс через веб-форму и элементы управления.
* Пользователь не может редактировать или удалять рейсы других пользователей.
* Пользователь может импортировать корректный CSV файл через функцию загрузки в веб-приложении, и данные появляются в общем списке рейсов с правильными часовыми поясами и привязанные к его профилю.
* При импорте некорректного CSV файла пользователь получает подробный отчет об ошибках в веб-интерфейсе.
* Список всех публичных рейсов корректно отображается с пагинацией и сортировкой в веб-интерфейсе.
* Фильтры по дате, авиакомпании, городам корректно применяются к видимому списку рейсов в веб-интерфейсе.
* Пользователь может успешно найти других зарегистрированных пользователей по имени.
* При просмотре профиля пользователя (включая свой) корректно отображается его статистика: общее количество рейсов и суммарное время в воздухе.
* Пользователь может выбрать нескольких пользователей и увидеть корректное сравнение их статистики.
* Пользователь А видит рейсы пользователя Б.
* Веб-приложение корректно отображается на десктопе (Chrome, Firefox) и мобильном устройстве (iOS Safari, Android Chrome) в браузере.

---